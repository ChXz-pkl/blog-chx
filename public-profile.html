<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profil Pengguna - RZF Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .kategori-badge {
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #c7d2fe;
        }

        .kategori-badge:hover {
            background-color: #c7d2fe;
        }

        .kategori-badge.active {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            border-color: #4f46e5;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
        
        .card-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .card-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .card-image-preview {
            width: 100%;
            height: 150px;
            object-fit: contain;
            border-radius: 0.5rem;
        }

        .card-text-preview {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .card-meta {
            margin-top: auto;
        }
    </style>
</head>

<body class="bg-sky-50 min-h-screen flex flex-col">

    <div id="toast-container" class="fixed top-5 right-5 z-[120] space-y-2"></div>
    
    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-blue-600 to-sky-400 text-white px-4 py-3 shadow-md sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <a class="text-xl font-bold" href="dashboard.html">RZF Academy</a>
            <button id="menu-toggle" class="md:hidden text-2xl focus:outline-none">&#9776;</button>
        </div>
        <div id="nav-menu"
            class="hidden md:flex flex-col md:flex-row mt-3 md:mt-0 md:items-center md:justify-between md:space-x-4">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-2 md:space-y-0 mt-2 md:mt-0">
                <a href="dashboard.html" class="hover:text-sky-200">Dashboard</a>
                <a href="galeri.html" class="hover:text-sky-200">Galeri</a>
                <a href="text.html" class="hover:text-sky-200">Teks</a>
                <a href="my.html" class="hover:text-sky-200">Konten Saya</a>
                <a href="upload.html" class="hover:text-sky-200">Upload</a>
                <a id="adminLink" href="admin.html"
                    class="px-3 py-1 bg-red-500 rounded-md text-white font-bold hidden">Panel Admin</a>
            </div>
            <div class="flex items-center gap-3 mt-3 md:mt-0">
                <a href="profil.html" class="flex items-center space-x-2 group">
                    <img id="navbarProfilePicture" src="https://placehold.co/32x32/e2e8f0/718096?text=U"
                        class="w-8 h-8 rounded-full border border-sky-200 group-hover:border-white transition" />
                    <span id="welcomeUser" class="font-semibold group-hover:text-sky-200 transition">Pengguna</span>
                </a>
                <button id="logout-button"
                    class="px-3 py-1 border border-white rounded hover:bg-white hover:text-blue-600 text-sm font-semibold">Logout</button>
            </div>
        </div>
    </nav>


    <main class="flex-1 container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Loading and Error Section -->
            <div id="loadingProfile" class="flex flex-col items-center justify-center p-10 hidden">
                <div class="loading-spinner"></div>
                <p class="mt-3 text-gray-600">Memuat data profil...</p>
            </div>
            <div id="errorProfile" class="text-center p-10 hidden">
                <p class="text-red-500 font-semibold">Terjadi kesalahan saat memuat profil.</p>
                <p class="text-gray-500 mt-2">Pastikan tautan profil benar dan coba lagi.</p>
            </div>
            
            <!-- Profile Info Section -->
            <div id="profileContent" class="hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8">
                    <img id="profilePicture" src="https://placehold.co/150x150/e2e8f0/718096?text=U"
                        alt="Foto Profil"
                        class="w-36 h-36 rounded-full object-cover border-4 border-white shadow-md">
                    <div class="text-center md:text-left">
                        <h2 id="profileName" class="text-3xl font-bold text-blue-600 mb-1">Nama Pengguna</h2>
                        <p id="profileEmail" class="text-gray-500 text-sm italic">email@contoh.com</p>
                        <div class="flex flex-wrap justify-center md:justify-start gap-4 mt-3">
                            <p class="text-gray-700 font-semibold">Total Postingan: <span id="postCountNumber">0</span></p>
                            <p class="text-gray-700 font-semibold">Total Suka: <span id="likeCountNumber">0</span></p>
                            <p class="text-gray-700 font-semibold">Total Cinta: <span id="loveCountNumber">0</span></p>
                        </div>
                    </div>
                </div>

                <!-- Konten Publik Pengguna -->
                <div class="mt-8">
                    <h3 class="text-2xl font-bold text-blue-600 mb-4">Konten Publik</h3>
                    <div id="userKontenContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Konten pengguna akan dimuat di sini -->
                        <div id="loadingKonten" class="col-span-full flex flex-col items-center justify-center p-10">
                            <div class="loading-spinner"></div>
                            <p class="mt-3 text-gray-600">Memuat konten pengguna...</p>
                        </div>
                    </div>
                    <div id="noContentMessage" class="col-span-full text-center p-10 hidden">
                        <p class="text-gray-500">Pengguna ini belum mengunggah konten publik.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="previewOverlay" class="fixed inset-0 bg-black bg-opacity-80 hidden justify-center items-center z-[120]">
        <span id="close-preview" class="absolute top-5 right-6 text-white text-4xl cursor-pointer font-bold">&times;</span>
        <img id="previewImage" class="max-w-[90%] max-h-[90%] rounded shadow-2xl" />
    </div>

    <div id="bacaModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden justify-center items-center z-[120]">
        <div class="bg-white max-w-xl w-full mx-4 p-6 rounded-xl shadow-lg relative">
            <button id="close-baca" class="absolute top-2 right-2 text-gray-600 hover:text-red-500 text-xl font-bold">✖</button>
            <h2 id="judulBaca" class="text-xl font-bold mb-2 text-blue-700 md:text-center"></h2>
            <div class="max-h-[60vh] overflow-y-auto">
                <p id="isiBaca" class="break-words text-gray-800 whitespace-pre-line leading-relaxed text-sm"></p>
            </div>
        </div>
    </div>
    
    <div id="bookModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden justify-center items-center z-[120]">
        <div class="bg-white rounded-xl shadow-lg relative mx-4" id="bookViewModal">
            <button id="close-book" class="absolute top-2 right-2 text-gray-600 hover:text-red-500 text-xl font-bold z-10">✖</button>
            <div class="flex flex-col md:flex-row w-full h-full">
                <div class="cover-container p-6 flex flex-col items-center justify-center">
                    <img id="bookCover" src="" alt="Cover Buku"
                        class="w-full max-h-96 object-contain rounded-lg shadow-xl" />
                    <h2 id="bookTitle" class="text-xl font-bold text-blue-700 mt-4 text-center"></h2>
                    <span id="bookAuthor" class="text-sm text-gray-600"></span>
                </div>
                <div class="text-container p-6 flex flex-col">
                    <p id="bookContentText" class="flex-1"></p>
                    <div id="bookPageControls" class="page-controls">
                        <button id="prevPageBtn"
                            class="px-4 py-2 bg-blue-500 text-white rounded-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                            &larr; Sebelumnya
                        </button>
                        <span id="pageNumber" class="text-sm text-gray-600">Halaman 1 dari 1</span>
                        <button id="nextPageBtn"
                            class="px-4 py-2 bg-blue-500 text-white rounded-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                            Berikutnya &rarr;
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="bg-gray-100 text-center text-gray-600 py-4 text-sm mt-auto">
        &copy; 2025 <a href="https://portfolio-chx.netlify.app/"
            class="font-semibold text-black hover:underline">CHX</a> • All rights reserved.
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getDatabase, ref, get, query, orderByChild, equalTo, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAZF0O1y9nqZAuDXgwMf3vucM5OD1goavQ",
            authDomain: "rzf-academy-bd.firebaseapp.com",
            databaseURL: "https://rzf-academy-bd-default-rtdb.firebaseio.com",
            projectId: "rzf-academy-bd",
            storageBucket: "rzf-academy-bd.appspot.com",
            messagingSenderId: "875822158869",
            appId: "1:875822158869:web:a88c284f1d031d9da3aa1c",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Elemen UI ---
        const profileContentEl = document.getElementById('profileContent');
        const profilePictureEl = document.getElementById('profilePicture');
        const profileNameEl = document.getElementById('profileName');
        const profileEmailEl = document.getElementById('profileEmail');
        const postCountEl = document.getElementById('postCountNumber');
        const likeCountEl = document.getElementById('likeCountNumber');
        const loveCountEl = document.getElementById('loveCountNumber');
        const userKontenContainerEl = document.getElementById('userKontenContainer');
        const loadingProfileEl = document.getElementById('loadingProfile');
        const errorProfileEl = document.getElementById('errorProfile');
        const loadingKontenEl = document.getElementById('loadingKonten');
        const noContentMessageEl = document.getElementById('noContentMessage');

        // Modal Elements
        const previewOverlay = document.getElementById("previewOverlay");
        const previewImage = document.getElementById("previewImage");
        const bacaModal = document.getElementById("bacaModal");
        const judulBaca = document.getElementById("judulBaca");
        const isiBaca = document.getElementById("isiBaca");
        const bookModal = document.getElementById('bookModal');
        const bookCoverEl = document.getElementById('bookCover');
        const bookTitleEl = document.getElementById('bookTitle');
        const bookAuthorEl = document.getElementById('bookAuthor');
        const bookContentTextEl = document.getElementById('bookContentText');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageNumberEl = document.getElementById('pageNumber');

        let loggedInUser = null;
        let bookContentPages = [];
        let currentPage = 0;


        // --- Fungsi Utilitas ---
        function showToast(m, t = 'success') {
            const n = document.getElementById("toast-container");
            const e = document.createElement("div");
            const o = { success: "bg-green-500", error: "bg-red-500", info: "bg-sky-500" };
            e.className = `w-auto max-w-xs p-4 text-white rounded-lg shadow-lg animate-f-in-r ${o[t]}`;
            e.textContent = m;
            const a = document.createElement("style");
            a.id = "toast-animation-style";
            a.innerHTML = "@keyframes f-in-r{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}.animate-f-in-r{animation:f-in-r .5s ease-out forwards}";
            document.head.appendChild(a);
            n.appendChild(e);
            setTimeout(() => e.remove(), 3000);
        }

        const logout = () => signOut(auth).then(() => {
            localStorage.removeItem("loggedInUser");
            showToast("Anda berhasil logout.");
            setTimeout(() => window.location.href = "index.html", 1500);
        });

        const tampilkanPreview = (src) => {
            previewImage.src = src;
            previewOverlay.style.display = "flex";
            document.body.style.overflow = 'hidden';
        };

        const tutupPreview = () => {
            previewOverlay.style.display = "none";
            document.body.style.overflow = '';
        };

        const bukaBaca = (judul, teks) => {
            judulBaca.textContent = judul;
            isiBaca.innerHTML = teks.replace(/\n/g, "<br>");
            bacaModal.style.display = "flex";
            document.body.style.overflow = 'hidden';
        };

        const tutupBaca = () => {
            bacaModal.style.display = "none";
            document.body.style.overflow = '';
        };
        
        const renderBookPage = () => {
            if (bookContentPages.length > 0) {
                bookContentTextEl.innerHTML = bookContentPages[currentPage].content;
                pageNumberEl.textContent = `Halaman ${currentPage + 1} dari ${bookContentPages.length}`;
            } else {
                bookContentTextEl.textContent = "Konten buku kosong.";
                pageNumberEl.textContent = `Halaman 0 dari 0`;
            }

            prevPageBtn.disabled = currentPage === 0;
            nextPageBtn.disabled = currentPage === bookContentPages.length - 1;

            bookContentTextEl.scrollTo(0, 0);
        };
        const bukaBuku = (item) => {
            bookTitleEl.textContent = item.judul;
            bookAuthorEl.textContent = `Oleh: ${item.userName}`;
            bookCoverEl.src = item.gambar || 'https://placehold.co/300x450?text=Cover+Buku';
            bookModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            try {
                const isJson = (str) => {
                    try { JSON.parse(str); } catch (e) { return false; }
                    return true;
                };
                if (isJson(item.teks)) {
                    bookContentPages = JSON.parse(item.teks);
                } else {
                    bookContentPages = [{ content: item.teks || '' }];
                }
            } catch (e) {
                bookContentPages = [{ content: item.teks || '' }];
            }
            currentPage = 0;
            renderBookPage();
        };

        // --- Fetch & Render Konten Pengguna ---
        const fetchAndRenderUserContent = async (userId) => {
            loadingKontenEl.style.display = 'flex';
            userKontenContainerEl.style.display = 'none';
            noContentMessageEl.style.display = 'none';
            
            const kontenRef = ref(db, 'konten');
            const userContentQuery = query(kontenRef, orderByChild('userId'), equalTo(userId));

            try {
                const snapshot = await get(userContentQuery);
                const userContent = [];
                let totalLikes = 0;
                let totalLoves = 0;

                // Cek jika snapshot.val() ada dan merupakan objek/array
                const contents = snapshot.val() ? Object.values(snapshot.val()) : [];

                for (const item of contents) {
                    // Hanya tampilkan konten yang bukan draft
                    if (item.jenis !== 'buku' || !item.isDraft) {
                        // Ambil reaksi untuk setiap konten
                        const reactionsSnapshot = await get(ref(db, `reactions/${item.id}`));
                        const reactionsData = reactionsSnapshot.val() || {};
                        item.likeCount = Object.values(reactionsData).filter(r => r.type === 'like').length;
                        item.loveCount = Object.values(reactionsData).filter(r => r.type === 'love').length;

                        totalLikes += item.likeCount;
                        totalLoves += item.loveCount;

                        userContent.push(item);
                    }
                }

                userContent.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));
                
                postCountEl.textContent = userContent.length;
                likeCountEl.textContent = totalLikes;
                loveCountEl.textContent = totalLoves;

                if (userContent.length === 0) {
                    noContentMessageEl.style.display = 'block';
                } else {
                    userKontenContainerEl.style.display = 'grid';
                    userContent.forEach(item => {
                        const card = document.createElement("div");
                        card.className = "bg-white rounded-lg shadow hover:shadow-lg p-4 flex flex-col transition-shadow";
                        
                        let contentHTML = '';

                        if (item.jenis === 'gambar') {
                            contentHTML = `
                                <div>
                                    <img src="${item.gambar}" alt="${item.judul}" class="w-full h-48 object-contain bg-gray-100 rounded mb-3 shadow-sm cursor-pointer"/>
                                    <h3 class="text-lg font-semibold text-blue-700 truncate mb-1">${item.judul}</h3>
                                </div>
                                <div class="mt-auto pt-3 border-t">
                                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">${item.kategori}</span>
                                </div>
                                `;
                        } else if (item.jenis === 'teks') {
                            const fullText = item.teks || "";
                            const preview = fullText.slice(0, 200).replace(/\n/g, "<br>");
                            contentHTML = `
                                <div>
                                    <h3 class="text-lg font-semibold text-blue-700 mb-2">${item.judul}</h3>
                                    <p class="text-gray-800 leading-relaxed min-h-[64px] break-words">${preview}${fullText.length > 200 ? '...' : ''}</p>
                                    ${fullText.length > 200 ? `<div class="mt-2"><button class="text-sm text-blue-600 hover:underline baca-btn">Baca Selengkapnya</button></div>` : ''}
                                </div>
                                <div class="mt-auto pt-3 border-t">
                                    <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">${item.kategori}</span>
                                </div>
                                `;
                        } else if (item.jenis === 'buku') {
                            let firstPageContent = '';
                            let hasMorePages = false;
                            try {
                                const isJson = (str) => {
                                    try { JSON.parse(str); } catch (e) { return false; }
                                    return true;
                                };
                                if (isJson(item.teks)) {
                                    const pages = JSON.parse(item.teks);
                                    if (pages.length > 0 && pages[0].content) {
                                        firstPageContent = pages[0].content;
                                        hasMorePages = pages.length > 1;
                                    }
                                } else {
                                    firstPageContent = item.teks || '';
                                    hasMorePages = firstPageContent.length > 150;
                                }
                            } catch (e) {
                                firstPageContent = item.teks || '';
                                hasMorePages = firstPageContent.length > 150;
                            }
                            firstPageContent = firstPageContent.replace(/<[^>]*>/g, '').trim();
                            firstPageContent = firstPageContent.substring(0, 150);
                            
                            contentHTML = `
                                <div>
                                    <img src="${item.gambar || 'https://placehold.co/400x250?text=Cover+Buku'}" alt="Cover Buku" class="w-full h-48 object-contain bg-gray-100 rounded mb-3 shadow-sm cursor-pointer"/>
                                    <h3 class="text-lg font-semibold text-blue-700 truncate mb-1">${item.judul}</h3>
                                </div>
                                <div class="mt-auto pt-3 border-t">
                                    <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">${item.kategori}</span>
                                </div>
                                `;
                        }
                        
                        card.innerHTML = contentHTML;

                        if (item.jenis === 'gambar') {
                            card.querySelector('img').addEventListener('click', () => tampilkanPreview(item.gambar));
                        } else if (item.jenis === 'teks') {
                            const bacaBtn = card.querySelector('.baca-btn');
                            if (bacaBtn) {
                                bacaBtn.addEventListener('click', () => bukaBaca(item.judul, item.teks));
                            }
                        } else if (item.jenis === 'buku') {
                            card.querySelector('img').addEventListener('click', () => bukaBuku(item));
                        }

                        userKontenContainerEl.appendChild(card);
                    });
                }
                
            } catch (error) {
                console.error("Error fetching user content:", error);
                showToast("Gagal memuat konten pengguna.", "error");
                userKontenContainerEl.innerHTML = `<p class="col-span-full text-center text-red-500">Gagal memuat konten.</p>`;
            } finally {
                loadingKontenEl.style.display = 'none';
            }
        };

        // --- Event Listeners Navbar & Modals ---
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('logout-button').addEventListener('click', logout);
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('nav-menu').classList.toggle("hidden");
            });

            document.getElementById('close-preview').addEventListener('click', tutupPreview);
            previewOverlay.addEventListener('click', (e) => { if (e.target === previewOverlay) tutupPreview(); });

            document.getElementById('close-baca').addEventListener('click', tutupBaca);
            bacaModal.addEventListener('click', (e) => { if (e.target === bacaModal) tutupBaca(); });
            
            document.getElementById('close-book').addEventListener('click', () => {
                bookModal.style.display = 'none';
                document.body.style.overflow = '';
            });
            bookModal.addEventListener('click', (e) => {
                if (e.target === bookModal) {
                    bookModal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            });
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    renderBookPage();
                }
            });
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < bookContentPages.length - 1) {
                    currentPage++;
                    renderBookPage();
                }
            });


            // Dapatkan user ID dari URL
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id');

            if (userId) {
                loadingProfileEl.style.display = 'flex';
                
                // Ambil data profil pengguna
                get(ref(db, 'users/' + userId))
                    .then(snapshot => {
                        loadingProfileEl.style.display = 'none';
                        if (snapshot.exists()) {
                            const userProfile = snapshot.val();
                            profileContentEl.style.display = 'block';
                            profileNameEl.textContent = userProfile.name;
                            profileEmailEl.textContent = userProfile.email;
                            profilePictureEl.src = userProfile.profilePicture || "https://placehold.co/150x150/e2e8f0/718096?text=U";
                            
                            // Ambil dan tampilkan konten pengguna
                            fetchAndRenderUserContent(userId);
                        } else {
                            errorProfileEl.textContent = "Pengguna tidak ditemukan.";
                            errorProfileEl.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching user profile:", error);
                        loadingProfileEl.style.display = 'none';
                        errorProfileEl.style.display = 'block';
                    });
            } else {
                errorProfileEl.textContent = "ID pengguna tidak ditemukan dalam URL.";
                errorProfileEl.style.display = 'block';
            }
            
            // --- Cek status login pengguna untuk navbar ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
                    if (loggedInUser && loggedInUser.id === user.uid) {
                        document.getElementById("welcomeUser").textContent = loggedInUser.name;
                        if (loggedInUser.profilePicture) document.getElementById("navbarProfilePicture").src = loggedInUser.profilePicture;
                        if (loggedInUser.role === 'admin') document.getElementById("adminLink").style.display = 'inline-block';
                    } else {
                        // Jika ada user login tapi bukan user yang datanya di localStorage, paksa logout
                        logout();
                    }
                }
            });
        });
    </script>
</body>

</html>
